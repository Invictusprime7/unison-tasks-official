import React, { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import { X, Send, Sparkles, Loader2, Hammer, Code, Palette, Wand2, FileCode, Zap } from 'lucide-react';
import { Canvas as FabricCanvas } from 'fabric';
import { useWebBuilderAI } from '@/hooks/useWebBuilderAI';
import { supabase } from '@/integrations/supabase/client';
import { toast } from 'sonner';
import type { AIGeneratedTemplate } from '@/types/template';
import { sanitizeHTMLClasses } from '@/utils/classSanitizer';

interface Message {
  role: 'user' | 'assistant';
  content: string;
  template?: AIGeneratedTemplate;
  code?: {
    html: string;
    css: string;
    javascript: string;
  };
  codeType?: 'typescript' | 'javascript' | 'react' | 'vanilla';
}

interface CodeGenerationResponse {
  html: string;
  css: string;
  javascript: string;
  explanation: string;
  features: string[];
}

interface AIAssistantPanelProps {
  isOpen: boolean;
  onClose: () => void;
  fabricCanvas: FabricCanvas | null;
  onTemplateGenerated?: (template: AIGeneratedTemplate) => void;
  onCodeGenerated?: (code: string, type: 'html' | 'css' | 'javascript') => void;
}

export const AIAssistantPanel: React.FC<AIAssistantPanelProps> = ({ 
  isOpen, 
  onClose, 
  fabricCanvas, 
  onTemplateGenerated,
  onCodeGenerated 
}) => {
  const [messages, setMessages] = useState<Message[]>([
    {
      role: 'assistant',
      content: 'ðŸŽ¨ **Elite UI/UX Design Assistant**\n\nI create modern glass morphism templates and convert code between languages. Try:\n\n**ðŸŽ¯ Design Commands:**\nâ€¢ "Create a modern SaaS landing page with glass effects"\nâ€¢ "Generate a portfolio with animated glass cards"\nâ€¢ "Design a pricing section with frosted glass"\nâ€¢ "Build a hero section with gradient overlays"\n\n**âš¡ Code Commands:**\nâ€¢ "Convert this TypeScript to vanilla JavaScript"\nâ€¢ "Generate modern glass UI components"\nâ€¢ "Create responsive CSS with glass morphism"\nâ€¢ "Build interactive animations in vanilla JS"\n\n**ðŸš€ Advanced Features:**\nâ€¢ Glass morphism effects by default\nâ€¢ TypeScript â†” JavaScript conversion\nâ€¢ Elite UI/UX design patterns\nâ€¢ Modern animation systems'
    }
  ]);
  const [input, setInput] = useState('');
  const scrollRef = useRef<HTMLDivElement>(null);
  const [pendingTemplates, setPendingTemplates] = useState<Map<number, AIGeneratedTemplate>>(new Map());
  const [pendingCode, setPendingCode] = useState<Map<number, CodeGenerationResponse>>(new Map());
  const [currentMode, setCurrentMode] = useState<'design' | 'code'>('design');
  const { loading, generateDesign, generateTemplate } = useWebBuilderAI(
    fabricCanvas
  );

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  // Advanced code generation with TypeScript to JavaScript conversion
  const generateAdvancedCode = async (prompt: string): Promise<CodeGenerationResponse | null> => {
    try {
      // Detect request types
      const isPortfolioPrompt = /\b(portfolio|resume|cv|personal site|personal website|showcase|profile|about me|my work|developer portfolio|designer portfolio|professional|career|experience|skills|projects|work samples)\b/i.test(prompt);
      const isBookingPrompt = /\b(booking|book|appointment|calendar|schedule|reservation|platform|travel|hotel|flight|event|tickets|availability|reserve|date picker|booking system)\b/i.test(prompt);
      
      let enhancedPrompt;
      let requestType;
      
      if (isPortfolioPrompt) {
        enhancedPrompt = `ðŸ’¼ **ELITE PORTFOLIO DESIGN REQUEST** ðŸ’¼
        
        Create a sleek, professional, and uniquely adaptive portfolio website: ${prompt}
        
        ðŸŽ¨ **PORTFOLIO DESIGN INSPIRATION** (Based on high-end professional portfolios):
        - Deep teal/dark professional background with excellent contrast (#1e3a3a or similar)
        - Clean asymmetrical layout with focus areas and strategic white space
        - Professional typography hierarchy with modern sans-serif fonts
        - Subtle glass morphism effects on featured sections and cards
        - High-quality project showcase with clean card-based presentations
        - Clear contact integration with professional call-to-action buttons
        - Skills/focus areas displayed in organized, visually appealing panels
        
        ðŸš€ **PORTFOLIO-SPECIFIC REQUIREMENTS:**
        - Professional hero section with name, title, and compelling description
        - Skills/expertise showcase with modern visual representation
        - Project portfolio grid with hover effects and detailed descriptions
        - About section with professional narrative and personality
        - Contact section with multiple connection methods
        - Responsive design optimized for recruiters and clients
        - Fast loading with optimized images and smooth scrolling
        - Professional color palette that conveys expertise and trust
        - Strategic use of negative space for clean, uncluttered feel
        - Accessibility-first design for professional environments
        
        ðŸŽ¯ **PORTFOLIO ADAPTATION INTELLIGENCE:**
        - Automatically adapt layout based on profession (developer, designer, etc.)
        - Smart content suggestions based on industry standards
        - Flexible sections that can showcase different types of work
        - Professional tone while maintaining personality and uniqueness
        - Modern design trends without sacrificing professionalism
        - Mobile-first responsive design for all viewing scenarios`;
        
        requestType = 'elite-portfolio';
      } else if (isBookingPrompt) {
        enhancedPrompt = `ðŸ“… **ELITE BOOKING PLATFORM DESIGN REQUEST** ðŸ“…
        
        Create a professional, intuitive, and user-friendly booking platform: ${prompt}
        
        ðŸŽ¯ **BOOKING PLATFORM INSPIRATION** (Based on BookEase excellence):
        - Seamless booking experiences that reduce friction and increase conversions
        - Dynamic calendar interfaces with intuitive date selection
        - Professional indigo/blue color schemes (#4f46e5) for trust and reliability
        - Hero sections with compelling imagery and clear call-to-action buttons
        - Interactive maps with location markers and booking integration
        - Animated background elements (floating bubbles, particles) for engagement
        
        ðŸš€ **BOOKING-SPECIFIC REQUIREMENTS:**
        - Interactive calendar component with hover states and selection feedback
        - Form validation with real-time feedback and error handling
        - Step-by-step booking flows with progress indicators
        - Service selection with descriptions and pricing display
        - Contact information collection with proper validation
        - Modal systems for sign-up, login, and booking confirmation
        - Mobile-responsive navigation with hamburger menus
        
        ðŸ“‹ **FUNCTIONAL EXCELLENCE:**
        - Calendar date selection with disabled past dates and availability indicators
        - Smooth scrolling and section navigation between booking steps
        - Map integration using Leaflet.js for location-based services
        - Tailwind CSS framework for rapid, consistent styling
        - Card-based layouts for services, testimonials, and features
        - Professional typography with clear hierarchy and accessibility
        - Performance optimization with lazy loading and efficient code
        
        ðŸŽ¨ **BOOKING FLOW DESIGN:**
        - Trust-building elements: testimonials, security badges, clear policies
        - Visual feedback for all user interactions and form submissions
        - Loading states and confirmation messages for booking completion
        - Integration points for payment processing and email confirmations
        - Responsive design optimized for mobile booking scenarios
        - Error handling with helpful messages and recovery suggestions`;
        
        requestType = 'elite-booking-platform';
      } else {
        enhancedPrompt = `ðŸŽ¨ **ELITE CREATIVE DESIGN REQUEST** ðŸŽ¨
        
        Create an immersive, visually stunning, and highly creative web experience: ${prompt}
        
        ðŸš€ **IMMERSIVE REQUIREMENTS:**
        - Stunning glass morphism effects with deep blur and transparency layers
        - Dynamic gradient backgrounds with animated color shifts
        - Advanced GSAP animations with timeline sequences and parallax effects
        - Interactive particle systems and micro-interactions
        - Cinematic transitions and scroll-triggered animations
        - Premium typography with custom font stacks and dynamic sizing
        - Creative layouts with asymmetric grids and floating elements
        - Immersive hover effects with 3D transforms and shadow play
        - Advanced CSS techniques: masks, filters, backdrop-blur, mix-blend-mode
        - Responsive design with fluid typography and adaptive layouts
        - Creative use of CSS custom properties for theming and animation
        - Modern JavaScript with intersection observers and performance optimization
        - Accessibility features integrated seamlessly
        - Mobile-first approach with touch-friendly interactions
        
        ðŸŽ¯ **CREATIVE GOALS:**
        - Push the boundaries of modern web design
        - Create memorable, engaging user experiences
        - Use cutting-edge CSS and JavaScript techniques
        - Implement smooth, buttery animations at 60fps
        - Design for emotional impact and user delight
        - Incorporate storytelling through visual design`;
        
        requestType = 'immersive-web-experience';
      }

      const { data, error } = await supabase.functions.invoke('ai-web-assistant', {
        body: { 
          prompt: enhancedPrompt,
          codeType: requestType,
          style: isPortfolioPrompt ? 'professional-portfolio' : 
                 isBookingPrompt ? 'booking-platform' : 'creative-glass-morphism',
          features: isPortfolioPrompt 
            ? ['portfolio', 'professional', 'adaptive', 'showcase', 'contact', 'responsive']
            : isBookingPrompt
            ? ['booking', 'calendar', 'forms', 'maps', 'responsive', 'interactive', 'validation']
            : ['immersive', 'creative', 'advanced-animations', 'interactive', 'cinematic', 'premium-effects']
        }
      });

      if (error) {
        console.error('Code generation error:', error);
        toast.error('Failed to generate code: ' + error.message);
        return null;
      }

      return data as CodeGenerationResponse;
    } catch (error) {
      console.error('Error in code generation:', error);
      toast.error('An unexpected error occurred during code generation');
      return null;
    }
  };

  // TypeScript to JavaScript conversion utility
  const convertTypeScriptToJavaScript = (tsCode: string): string => {
    // Basic TypeScript to JavaScript conversion
    return tsCode
      // Remove type annotations
      .replace(/:\s*\w+(\[\])?(\s*\||\s*&|\s*=|\s*,|\s*\)|\s*;|\s*{)/g, '$1')
      // Remove interface/type definitions
      .replace(/interface\s+\w+\s*{[^}]*}/g, '')
      .replace(/type\s+\w+\s*=\s*[^;]+;/g, '')
      // Remove generic type parameters
      .replace(/<[^>]*>/g, '')
      // Remove as assertions
      .replace(/\s+as\s+\w+/g, '')
      // Convert arrow functions with types
      .replace(/\(\s*(\w+):\s*\w+\s*\)/g, '($1)')
      // Remove explicit return types
      .replace(/\):\s*\w+\s*=>/g, ') =>')
      // Clean up extra whitespace
      .replace(/\s+/g, ' ')
      .trim();
  };

  const handleSend = async () => {
    if (!input.trim() || loading) return;

    const userMessage: Message = { role: 'user', content: input };
    setMessages(prev => [...prev, userMessage]);
    const userInput = input;
    setInput('');

    // Detect request type with enhanced creative keywords
    const isTemplateRequest = /\b(template|page|website|landing page|full design|complete design|entire page)\b/i.test(userInput);
    const isCodeRequest = /\b(code|convert|typescript|javascript|html|css|generate code|build component|create|design|build)\b/i.test(userInput);
    const isGlassRequest = /\b(glass|morphism|frosted|blur|transparent|modern ui)\b/i.test(userInput);
    const isCreativeRequest = /\b(immersive|creative|stunning|cinematic|artistic|premium|elite|advanced|beautiful|amazing|awesome|incredible|innovative|cutting-edge|interactive|dynamic|engaging|memorable|sophisticated|elegant|luxurious)\b/i.test(userInput);
    const isAnimationRequest = /\b(animate|animation|transition|scroll|parallax|particle|effect|micro-interaction|hover|smooth|fluid|motion)\b/i.test(userInput);
    const isPortfolioRequest = /\b(portfolio|resume|cv|personal site|personal website|showcase|profile|about me|my work|developer portfolio|designer portfolio|professional|career|experience|skills|projects|work samples)\b/i.test(userInput);
    const isBookingRequest = /\b(booking|book|appointment|calendar|schedule|reservation|platform|travel|hotel|flight|event|tickets|availability|reserve|date picker|booking system)\b/i.test(userInput);

    let response;
    
    if (isCodeRequest || isCreativeRequest || isAnimationRequest || isPortfolioRequest || isBookingRequest || currentMode === 'code') {
      // Advanced code generation with glass morphism
      response = await generateAdvancedCode(userInput);
      
      if (response) {
        const messageIndex = messages.length + 1;
        const assistantMessage: Message = {
          role: 'assistant',
          content: `ðŸ’Ž **Glass UI Code Generated!**\n\n${response.explanation}\n\nðŸ”® **Features:**\n${response.features.map(f => `â€¢ ${f}`).join('\n')}\n\nðŸ“ **Code includes:**\nâ€¢ Modern HTML structure\nâ€¢ Glass morphism CSS\nâ€¢ Interactive JavaScript\nâ€¢ Responsive design\n\nUse the code blocks below or click "Apply Code" to integrate!`,
          code: {
            html: sanitizeHTMLClasses(response.html),
            css: response.css,
            javascript: response.javascript
          },
          codeType: 'javascript'
        };
        setMessages(prev => [...prev, assistantMessage]);
        setPendingCode(prev => new Map(prev).set(messageIndex, response));
      } else {
        const errorMessage: Message = {
          role: 'assistant',
          content: 'Sorry, I encountered an error generating that code. Please try again with a more specific prompt.'
        };
        setMessages(prev => [...prev, errorMessage]);
      }
    } else if (isTemplateRequest || isGlassRequest) {
      // Enhanced template generation with glass effects
      const enhancedPrompt = isGlassRequest 
        ? `${userInput} - Create with modern glass morphism effects, frosted glass backgrounds, blur effects, and premium animations`
        : userInput;
        
      response = await generateTemplate(enhancedPrompt);
      
      if (response && response.template) {
        const messageIndex = messages.length + 1;
        const assistantMessage: Message = {
          role: 'assistant',
          content: `âœ¨ **Glass Template Generated!**\n\n${response.explanation || 'Your glass morphism template is ready'}\n\nï¿½ **Template Features:**\nâ€¢ ${response.template.sections.length} glass sections\nâ€¢ ${response.template.name}\nâ€¢ Modern animations\nâ€¢ Responsive design\n\nClick "Build to Canvas" to make it fully editable!`,
          template: response.template
        };
        setMessages(prev => [...prev, assistantMessage]);
        setPendingTemplates(prev => new Map(prev).set(messageIndex, response.template));
      } else {
        const errorMessage: Message = {
          role: 'assistant',
          content: 'Sorry, I encountered an error creating that template. Please try again with a different prompt.'
        };
        setMessages(prev => [...prev, errorMessage]);
      }
    } else {
      // Canvas design elements
      response = await generateDesign(userInput);
      
      if (response) {
        const assistantMessage: Message = {
          role: 'assistant',
          content: response.explanation || 'Design elements added to canvas!'
        };
        setMessages(prev => [...prev, assistantMessage]);
      } else {
        const errorMessage: Message = {
          role: 'assistant',
          content: 'Sorry, I encountered an error creating that design. Please try again with a different prompt.'
        };
        setMessages(prev => [...prev, errorMessage]);
      }
    }
  };

  const handleBuildToCanvas = async (messageIndex: number) => {
    const template = pendingTemplates.get(messageIndex);
    if (!template) {
      console.error('Template not found for message index:', messageIndex);
      return;
    }

    console.log('[AIAssistantPanel] Building template to canvas:', template);
    
    if (onTemplateGenerated) {
      await onTemplateGenerated(template);
      toast.success('Template built to canvas! âœ¨');
    }
  };

  const handleApplyCode = (messageIndex: number, codeType: 'html' | 'css' | 'javascript') => {
    const codeResponse = pendingCode.get(messageIndex);
    if (!codeResponse || !onCodeGenerated) {
      console.error('Code not found for message index:', messageIndex);
      return;
    }

    const code = codeResponse[codeType];
    if (code) {
      onCodeGenerated(code, codeType);
      toast.success(`${codeType.toUpperCase()} code applied! ðŸŽ¨`);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const designPrompts = [
    'Modern SaaS landing with glass effects',
    'Portfolio with animated glass cards',
    'Pricing section with frosted glass',
    'Hero with gradient overlays',
  ];

  const codePrompts = [
    'Convert TypeScript to vanilla JavaScript',
    'Generate glass morphism components',
    'Create responsive CSS animations',
    'Build interactive vanilla JS features',
  ];

  if (!isOpen) return null;

  return (
    <div className="fixed right-0 top-0 bottom-0 w-96 bg-white shadow-2xl z-50 flex flex-col border-l">
      {/* Header */}
      <div className="p-4 border-b flex items-center justify-between bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600">
        <div className="flex items-center gap-2">
          <div className="p-1 bg-white/20 rounded-lg backdrop-blur-sm">
            <Wand2 className="w-4 h-4 text-white" />
          </div>
          <div>
            <h2 className="font-semibold text-white text-sm">Elite AI Assistant</h2>
            <p className="text-xs text-white/70">
              {currentMode === 'design' ? 'ðŸŽ¨ Glass UI Designer' : 'âš¡ Code Converter'}
            </p>
          </div>
        </div>
        <Button
          variant="ghost"
          size="icon"
          onClick={onClose}
          className="text-white hover:bg-white/20"
        >
          <X className="w-4 h-4" />
        </Button>
      </div>

      {/* Mode Selector */}
      <div className="p-3 border-b bg-gradient-to-r from-purple-50 to-blue-50">
        <div className="flex gap-2 mb-2">
          <Button
            variant={currentMode === 'design' ? 'default' : 'outline'}
            size="sm"
            onClick={() => setCurrentMode('design')}
            className="flex-1"
          >
            <Palette className="w-3 h-3 mr-1" />
            Design
          </Button>
          <Button
            variant={currentMode === 'code' ? 'default' : 'outline'}
            size="sm"
            onClick={() => setCurrentMode('code')}
            className="flex-1"
          >
            <Code className="w-3 h-3 mr-1" />
            Code
          </Button>
        </div>
        <p className="text-xs text-gray-600 mb-2">
          {currentMode === 'design' ? 'ðŸŽ¨ Design Mode:' : 'âš¡ Code Mode:'}
        </p>
        <div className="flex flex-wrap gap-2">
          {(currentMode === 'design' ? designPrompts : codePrompts).map((prompt) => (
            <button
              key={prompt}
              onClick={() => setInput(prompt)}
              className="text-xs px-2 py-1 bg-white border rounded-full hover:bg-purple-50 hover:border-purple-300 transition-colors"
            >
              {prompt}
            </button>
          ))}
        </div>
      </div>

      {/* Messages */}
      <ScrollArea className="flex-1 p-4" ref={scrollRef}>
        <div className="space-y-4">
          {messages.map((message, index) => (
            <div
              key={index}
              className={`flex flex-col ${message.role === 'user' ? 'items-end' : 'items-start'}`}
            >
              <div
                className={`max-w-[80%] rounded-lg p-3 ${
                  message.role === 'user'
                    ? 'bg-purple-600 text-white'
                    : 'bg-gray-100 text-gray-900'
                }`}
              >
                <p className="text-sm whitespace-pre-wrap">{message.content}</p>
              </div>
              
              {/* Build to Canvas button for template messages */}
              {message.role === 'assistant' && message.template && (
                <Button
                  onClick={() => handleBuildToCanvas(index)}
                  className="mt-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white"
                  size="sm"
                >
                  <Hammer className="w-4 h-4 mr-2" />
                  Build to Canvas
                </Button>
              )}

              {/* Code display and apply buttons for code messages */}
              {message.role === 'assistant' && message.code && (
                <div className="mt-2 w-full max-w-[90%] space-y-2">
                  {/* HTML Code */}
                  {message.code.html && (
                    <div className="bg-gray-900 rounded-lg p-3">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs text-gray-400 font-mono">HTML</span>
                        <Button
                          size="sm"
                          variant="secondary"
                          onClick={() => handleApplyCode(index, 'html')}
                          className="h-6 px-2 text-xs"
                        >
                          <FileCode className="w-3 h-3 mr-1" />
                          Apply
                        </Button>
                      </div>
                      <pre className="text-xs text-green-400 overflow-x-auto max-h-20">
                        <code>{message.code.html.substring(0, 200)}{message.code.html.length > 200 ? '...' : ''}</code>
                      </pre>
                    </div>
                  )}

                  {/* CSS Code */}
                  {message.code.css && (
                    <div className="bg-gray-900 rounded-lg p-3">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs text-gray-400 font-mono">CSS</span>
                        <Button
                          size="sm"
                          variant="secondary"
                          onClick={() => handleApplyCode(index, 'css')}
                          className="h-6 px-2 text-xs"
                        >
                          <Palette className="w-3 h-3 mr-1" />
                          Apply
                        </Button>
                      </div>
                      <pre className="text-xs text-blue-400 overflow-x-auto max-h-20">
                        <code>{message.code.css.substring(0, 200)}{message.code.css.length > 200 ? '...' : ''}</code>
                      </pre>
                    </div>
                  )}

                  {/* JavaScript Code */}
                  {message.code.javascript && (
                    <div className="bg-gray-900 rounded-lg p-3">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs text-gray-400 font-mono">
                          {message.codeType === 'typescript' ? 'TypeScript â†’ ' : ''}JavaScript
                        </span>
                        <Button
                          size="sm"
                          variant="secondary"
                          onClick={() => handleApplyCode(index, 'javascript')}
                          className="h-6 px-2 text-xs"
                        >
                          <Zap className="w-3 h-3 mr-1" />
                          Apply
                        </Button>
                      </div>
                      <pre className="text-xs text-yellow-400 overflow-x-auto max-h-20">
                        <code>{message.code.javascript.substring(0, 200)}{message.code.javascript.length > 200 ? '...' : ''}</code>
                      </pre>
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
          {loading && (
            <div className="flex justify-start">
              <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-3 flex items-center gap-2">
                <Loader2 className="w-4 h-4 animate-spin text-purple-600" />
                <p className="text-sm text-purple-700">
                  {currentMode === 'design' 
                    ? 'ðŸŽ¨ Crafting glass morphism design...' 
                    : 'âš¡ Generating optimized code...'}
                </p>
              </div>
            </div>
          )}
        </div>
      </ScrollArea>

      {/* Input */}
      <div className="p-4 border-t bg-gradient-to-r from-gray-50 to-gray-100">
        <div className="flex gap-2">
          <Input
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder={currentMode === 'design' 
              ? 'ðŸŽ¨ Describe your glass UI vision...' 
              : 'âš¡ Ask for code conversion or generation...'}
            disabled={loading}
            className="flex-1 border-purple-200 focus:ring-purple-500 focus:border-purple-500"
          />
          <Button
            onClick={handleSend}
            disabled={loading || !input.trim()}
            size="icon"
            className="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
          >
            {loading ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Send className="w-4 h-4" />
            )}
          </Button>
        </div>
        <p className="text-xs text-gray-500 mt-2 flex items-center gap-1">
          <Sparkles className="w-3 h-3" />
          Elite AI â€¢ TypeScript â†” JavaScript â€¢ Glass Morphism â€¢ Press Enter
        </p>
      </div>
    </div>
  );
};